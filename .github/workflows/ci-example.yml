name: Optimized CI with Diffalyzer

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git diff

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: xdebug

      - name: Install Dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run Affected Tests Only
        run: |
          # Get list of test files affected by changes
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TESTS=$(vendor/bin/diffalyzer --output test --from origin/${{ github.base_ref }})
          else
            TESTS=$(vendor/bin/diffalyzer --output test)
          fi

          # Run tests
          if [ -n "$TESTS" ]; then
            echo "Running affected tests: $TESTS"
            vendor/bin/phpunit $TESTS
          else
            echo "Running all tests (full scan triggered or no PHP changes)"
            vendor/bin/phpunit
          fi

  psalm:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Install Dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run Psalm on Affected Files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES=$(vendor/bin/diffalyzer --output files --from origin/${{ github.base_ref }})
          else
            FILES=$(vendor/bin/diffalyzer --output files)
          fi

          if [ -n "$FILES" ]; then
            echo "Analyzing affected files: $FILES"
            vendor/bin/psalm $FILES
          else
            echo "Analyzing all files"
            vendor/bin/psalm
          fi

  coding-standards:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Install Dependencies
        run: composer install --no-progress --prefer-dist

      - name: Run PHP-CS-Fixer on Affected Files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES=$(vendor/bin/diffalyzer --output files --from origin/${{ github.base_ref }})
          else
            FILES=$(vendor/bin/diffalyzer --output files)
          fi

          if [ -n "$FILES" ]; then
            echo "Checking affected files: $FILES"
            vendor/bin/php-cs-fixer fix --dry-run --diff $FILES
          else
            echo "Checking all files"
            vendor/bin/php-cs-fixer fix --dry-run --diff
          fi
